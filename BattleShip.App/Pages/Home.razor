@page "/"
@using BattleShip.Models.Entities
@using BattleShip.Models.Enums
@using BattleShip.Models.DTOs
@using BattleShip.Models.Interfaces
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Configuration
@inject IGameService GameService
@inject NavigationManager Navigation
@inject IConfiguration Configuration
@implements IAsyncDisposable

<PageTitle>BattleShip</PageTitle>

<h1>BattleShip</h1>

@if (IsInitializing)
{
    <div class="alert alert-info">Connexion au serveur en cours...</div>
}
@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (CurrentGame == null)
{
    <div class="mb-3">
        <label>Votre Nom / ID:</label>
        <input @bind="PlayerId" class="form-control" style="width: auto; display: inline-block;" />
    </div>
    <div class="mb-3">
        <label>Difficulté:</label>
        <select @bind="SelectedDifficulty" class="form-select" style="width: auto; display: inline-block;">
            <option value="@GameDifficulty.Easy">Facile (8x8, IA Aléatoire)</option>
            <option value="@GameDifficulty.Medium">Moyen (10x10, IA Standard)</option>
            <option value="@GameDifficulty.Hard">Difficile (12x12, IA Avancée)</option>
        </select>
    </div>
    <div class="mb-3">
        <input type="checkbox" @bind="IsSinglePlayer" id="sp" />
        <label for="sp">Solo (vs AI)</label>
    </div>
    <button class="btn btn-primary" @onclick="StartGame">Nouvelle Partie</button>
    <div class="mt-3">
        <label>Rejoindre une partie (ID):</label>
        <input @bind="JoinGameId" class="form-control" style="width: auto; display: inline-block;" />
        <button class="btn btn-secondary" @onclick="JoinGame">Rejoindre</button>
    </div>
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger mt-2">@ErrorMessage</div>
    }
}
else
{
    <div class="alert alert-info">
        <strong>Partie ID:</strong> @CurrentGame.Id <br/>
        <strong>Joueur:</strong> @PlayerId <br/>
        <strong>Statut:</strong> @CurrentGame.Status
        @if (!IsSinglePlayer && CurrentGame.Player2Id == null)
        {
            <br/><span>En attente d'un adversaire...</span>
        }
    </div>
}

@if (CurrentGame != null)
{
    @if (CurrentGame.Status == GameStatus.PlacingShips)
    {
        <div class="placement-container">
            <h3>Placez vos bateaux</h3>
            <div class="controls mb-3">
                <button class="btn btn-secondary" @onclick="ToggleOrientation">Orientation: @CurrentOrientation</button>
                <button class="btn btn-success" @onclick="SubmitShips" disabled="@(!AllShipsPlaced)">Valider</button>
                <button class="btn btn-danger" @onclick="ResetPlacement">Réinitialiser</button>
            </div>
            @if (!string.IsNullOrEmpty(PlacementWarning))
            {
                <div class="alert alert-warning mb-3">
                    @PlacementWarning
                </div>
            }
            <div class="ships-list mb-3">
                @foreach (var ship in AvailableShips)
                {
                    <button class="btn @(SelectedShip == ship ? "btn-primary" : "btn-outline-primary") me-2" 
                            @onclick="() => SelectShip(ship)"
                            disabled="@IsShipPlaced(ship.Name)">
                        @ship.Name (@ship.Size)
                    </button>
                }
            </div>
            <div class="board">
                <div class="grid" style="grid-template-columns: repeat(@(CurrentGame.Player1Board.Size), 30px); grid-template-rows: repeat(@(CurrentGame.Player1Board.Size), 30px);">
                    @for (int r = 0; r < CurrentGame.Player1Board.Size; r++)
                    {
                        @for (int c = 0; c < CurrentGame.Player1Board.Size; c++)
                        {
                            var row = r;
                            var col = c;
                            var isOccupied = IsPlacementCell(row, col);
                            <div class="cell @(isOccupied ? "ship" : "")" @onclick="() => PlaceShip(row, col)">
                                @if (isOccupied)
                                {
                                    <img src="images/ship.svg" alt="S" />
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="game-container">
            <div class="status-bar">
                <p>Status: <strong>@CurrentGame.Status</strong></p>
                <p>Tour: <strong>@(CurrentGame.CurrentTurnPlayerId == PlayerId ? "A vous" : "Adversaire")</strong></p>
                <button class="btn btn-warning btn-sm" @onclick="RestartGame">Recommencer</button>
                <button class="btn btn-secondary btn-sm" @onclick="UndoLastMove">Annuler</button>
                @if (CurrentGame.WinnerId != null)
                {
                    <div class="alert alert-success">
                        Vainqueur: @CurrentGame.WinnerId
                    </div>
                    <button class="btn btn-primary" @onclick="StartGame">Nouvelle Partie</button>
                }
            </div>

            <div class="boards">
                <div class="board">
                    <h3>Adversaire (Tirez ici)</h3>
                    <div class="grid" style="grid-template-columns: repeat(@(CurrentGame.Player1Board.Size), 30px); grid-template-rows: repeat(@(CurrentGame.Player1Board.Size), 30px);">
                        @for (int r = 0; r < CurrentGame.Player1Board.Size; r++)
                        {
                            @for (int c = 0; c < CurrentGame.Player1Board.Size; c++)
                            {
                                var row = r;
                                var col = c;
                                var cellState = GetOpponentCellState(row, col);
                                <div class="cell @GetCellClass(cellState)" @onclick="() => Shoot(row, col)">
                                    @if (cellState == CellState.Hit || cellState == CellState.Sunk)
                                    {
                                        <img src="images/hit.png" alt="Hit" />
                                    }
                                    else if (cellState == CellState.Miss)
                                    {
                                        <img src="images/miss.png" alt="Miss" />
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="board">
                    <h3>Mon Plateau</h3>
                    <div class="grid" style="grid-template-columns: repeat(@(CurrentGame.Player1Board.Size), 30px); grid-template-rows: repeat(@(CurrentGame.Player1Board.Size), 30px);">
                        @for (int r = 0; r < CurrentGame.Player1Board.Size; r++)
                        {
                            @for (int c = 0; c < CurrentGame.Player1Board.Size; c++)
                            {
                                var row = r;
                                var col = c;
                                var cellState = GetMyCellState(row, col);
                                var hasShip = HasMyShip(row, col);
                                <div class="cell @(hasShip ? "ship" : "")">
                                    @if (cellState == CellState.Hit || cellState == CellState.Sunk)
                                    {
                                        <img src="images/hit.png" alt="Hit" />
                                    }
                                    else if (cellState == CellState.Miss)
                                    {
                                        <img src="images/miss.png" alt="Miss" />
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="history mt-4">
                <h3>Historique des coups</h3>
                <ul class="list-group" style="max-height: 200px; overflow-y: auto;">
                    @foreach (var move in MoveHistory)
                    {
                        <li class="list-group-item">
                            <strong>@move.PlayerId</strong> a tiré en (@move.Row, @move.Col) : 
                            <span class="@(move.Result == CellState.Hit.ToString() || move.Result == CellState.Sunk.ToString() ? "text-danger" : "text-muted")">
                                @move.Result
                            </span>
                            @if (!string.IsNullOrEmpty(move.SunkShipName))
                            {
                                <span class="badge bg-danger ms-2">Coulé : @move.SunkShipName !</span>
                            }
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
}

<div class="leaderboard mt-5">
    <h3>Leaderboard</h3>
    <table class="table table-striped" style="max-width: 400px;">
        <thead>
            <tr>
                <th>Joueur</th>
                <th>Victoires</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in Leaderboard)
            {
                <tr>
                    <td>@entry.PlayerId</td>
                    <td>@entry.Wins</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<style>
    .game-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .boards {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }
    .grid {
        display: grid;
        gap: 1px;
        background-color: #ccc;
        border: 1px solid #999;
    }
    .cell {
        width: 30px;
        height: 30px;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
    }
    .cell:hover {
        background-color: #eee;
    }
    .cell.ship {
        background-color: #aaa;
    }
    .cell img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
</style>

@code {
    private Game? CurrentGame;
    private string PlayerId = "Player-" + Guid.NewGuid().ToString().Substring(0, 8);
    private List<ShotResultDto> MyShots = new();
    private List<ShotResultDto> OpponentShots = new();
    private GameDifficulty SelectedDifficulty = GameDifficulty.Medium;
    private bool IsSinglePlayer = true;
    private string JoinGameId = "";
    private string ErrorMessage = "";
    private string PlacementWarning = "";
    private List<MoveHistoryDto> MoveHistory = new();

    // Placement Logic
    private List<ShipPlacementDto> PlacedShips = new();
    private List<ShipModel> AvailableShips = new()
    {
        new ShipModel("Carrier", 5),
        new ShipModel("Battleship", 4),
        new ShipModel("Cruiser", 3),
        new ShipModel("Submarine", 3),
        new ShipModel("Destroyer", 2)
    };
    private ShipModel? SelectedShip;
    private Orientation CurrentOrientation = Orientation.Horizontal;
    private record ShipModel(string Name, int Size);
    
    private HubConnection? hubConnection;
    private List<LeaderboardEntry> Leaderboard = new();

    private bool IsInitializing = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitAsync();
        }
    }

    private async Task InitAsync()
    {
        try
        {
            var backendUrl = Configuration["BackendUrl"] ?? Navigation.BaseUri;
            hubConnection = new HubConnectionBuilder()
                .WithUrl(new Uri(new Uri(backendUrl), "gamehub"))
                .Build();

            hubConnection.On<string>("GameStateUpdated", async (gameId) =>
            {
                if (CurrentGame != null && CurrentGame.Id == gameId)
                {
                    await RefreshGame();
                    StateHasChanged();
                }
            });

            await hubConnection.StartAsync();
            await LoadLeaderboard();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur de connexion au serveur: {ex.Message}. Assurez-vous que l'API est lancée sur {Configuration["BackendUrl"]}.";
            Console.WriteLine(ex);
        }
        finally
        {
            IsInitializing = false;
            StateHasChanged();
        }
    }

    private async Task LoadLeaderboard()
    {
        Leaderboard = await GameService.GetLeaderboardAsync();
    }

    private async Task RefreshGame()
    {
        if (CurrentGame == null) return;
        var game = await GameService.GetGameAsync(CurrentGame.Id);
        if (game != null)
        {
            UpdateLocalState(game);
            if (game.Status == GameStatus.Finished)
            {
                await LoadLeaderboard();
            }
        }
    }

    private async Task JoinHubGroup()
    {
        if (hubConnection is not null && CurrentGame != null)
        {
            await hubConnection.SendAsync("JoinGameGroup", CurrentGame.Id);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private void SelectShip(ShipModel ship) => SelectedShip = ship;
    private void ToggleOrientation() => CurrentOrientation = CurrentOrientation == Orientation.Horizontal ? Orientation.Vertical : Orientation.Horizontal;
    private bool IsShipPlaced(string name) => PlacedShips.Any(s => s.Name == name);
    private bool AllShipsPlaced => PlacedShips.Count == AvailableShips.Count;
    private void ResetPlacement() { PlacedShips.Clear(); SelectedShip = null; PlacementWarning = ""; }

    private void PlaceShip(int row, int col)
    {
        PlacementWarning = "";
        if (SelectedShip == null) return;
        if (IsShipPlaced(SelectedShip.Name)) return;

        // Check bounds
        if ((CurrentOrientation == Orientation.Horizontal && col + SelectedShip.Size > CurrentGame!.Player1Board.Size) ||
            (CurrentOrientation == Orientation.Vertical && row + SelectedShip.Size > CurrentGame!.Player1Board.Size))
        {
            PlacementWarning = "Attention : Emplacement indisponible !";
            return;
        }

        // Check overlap
        var newCoords = new List<Coordinate>();
        for (int i = 0; i < SelectedShip.Size; i++)
        {
            if (CurrentOrientation == Orientation.Horizontal) newCoords.Add(new Coordinate(row, col + i));
            else newCoords.Add(new Coordinate(row + i, col));
        }

        if (PlacedShips.Any(s => 
        {
            var sCoords = GetShipCoords(s);
            return sCoords.Any(c => newCoords.Contains(c));
        })) 
        {
            PlacementWarning = "Attention : Emplacement indisponible !";
            return;
        }

        var newShip = new ShipPlacementDto(SelectedShip.Name, SelectedShip.Size, row, col, CurrentOrientation);
        PlacedShips.Add(newShip);
        SelectedShip = null;
    }

    private List<Coordinate> GetShipCoords(ShipPlacementDto s)
    {
        var coords = new List<Coordinate>();
        for (int i = 0; i < s.Size; i++)
        {
            if (s.Orientation == Orientation.Horizontal) coords.Add(new Coordinate(s.Row, s.Col + i));
            else coords.Add(new Coordinate(s.Row + i, s.Col));
        }
        return coords;
    }

    private bool IsPlacementCell(int row, int col)
    {
        var coord = new Coordinate(row, col);
        return PlacedShips.Any(s => GetShipCoords(s).Contains(coord));
    }

    private async Task SubmitShips()
    {
        if (!AllShipsPlaced) return;
        try
        {
            var game = await GameService.PlaceShipsAsync(CurrentGame!.Id, PlayerId, PlacedShips);
            if (game != null)
            {
                UpdateLocalState(game);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error placing ships: {ex.Message}");
        }
    }

    private async Task StartGame()
    {
        try 
        {
            var game = await GameService.CreateGameAsync(PlayerId, IsSinglePlayer, SelectedDifficulty);
            UpdateLocalState(game);
            ResetPlacement(); // Reset placement state
            await JoinHubGroup();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting game: {ex.Message}");
        }
    }

    private async Task JoinGame()
    {
        ErrorMessage = "";
        if (!string.IsNullOrWhiteSpace(JoinGameId))
        {
            try
            {
                var game = await GameService.JoinGameAsync(JoinGameId, PlayerId);
                if (game != null)
                {
                    IsSinglePlayer = false;
                    UpdateLocalState(game);
                    ResetPlacement();
                    await JoinHubGroup();
                }
                else
                {
                    ErrorMessage = "Impossible de rejoindre la partie (Introuvable ou pleine).";
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Erreur: {ex.Message}";
            }
        }
    }

    private async Task RestartGame()
    {
        if (CurrentGame == null) return;
        try
        {
            var restartedGame = await GameService.RestartGameAsync(CurrentGame.Id, PlayerId);
            if (restartedGame != null)
            {
                UpdateLocalState(restartedGame);
                ResetPlacement();
                await JoinHubGroup();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error restarting game: {ex.Message}");
        }
    }

    private async Task UndoLastMove()
    {
        if (CurrentGame == null) return;
        try
        {
            var game = await GameService.UndoLastMoveAsync(CurrentGame.Id);
            if (game != null)
            {
                UpdateLocalState(game);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error undoing: {ex.Message}");
        }
    }

    private void UpdateLocalState(Game game)
    {
        CurrentGame = game;
        
        var opponentBoard = PlayerId == game.Player1Id ? game.Player2Board : game.Player1Board;
        var myBoard = PlayerId == game.Player1Id ? game.Player1Board : game.Player2Board;

        MyShots = opponentBoard.ShotsFired.Select(kvp => new ShotResultDto(kvp.Key.Row, kvp.Key.Column, kvp.Value)).ToList();
        OpponentShots = myBoard.ShotsFired.Select(kvp => new ShotResultDto(kvp.Key.Row, kvp.Key.Column, kvp.Value)).ToList();
        
        MoveHistory = game.MoveHistory.Select(m => new MoveHistoryDto(
            m.PlayerId, 
            m.Row, 
            m.Col, 
            m.Result.ToString(), 
            m.SunkShipName
        )).Reverse().ToList();
    }

    private async Task Shoot(int row, int col)
    {
        if (CurrentGame == null || CurrentGame.Status != GameStatus.InProgress || CurrentGame.CurrentTurnPlayerId != PlayerId)
            return;

        // Don't shoot if already shot
        if (MyShots.Any(s => s.Row == row && s.Column == col))
            return;

        try
        {
            var gameState = await GameService.ShootAsync(CurrentGame.Id, PlayerId, row, col);
            if (gameState != null)
            {
                UpdateGameState(gameState);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error shooting: {ex.Message}");
        }
    }

    private void UpdateGameState(GameStateDto dto)
    {
        if (CurrentGame == null) return;

        CurrentGame.Status = dto.Status;
        CurrentGame.CurrentTurnPlayerId = dto.CurrentTurnPlayerId;
        CurrentGame.WinnerId = dto.WinnerId;
        
        MyShots = dto.MyShots;
        OpponentShots = dto.OpponentShots;
        MoveHistory = dto.History.AsEnumerable().Reverse().ToList();
    }

    private CellState GetOpponentCellState(int row, int col)
    {
        var shot = MyShots.FirstOrDefault(s => s.Row == row && s.Column == col);
        return shot?.State ?? CellState.Empty;
    }

    private CellState GetMyCellState(int row, int col)
    {
        var shot = OpponentShots.FirstOrDefault(s => s.Row == row && s.Column == col);
        return shot?.State ?? CellState.Empty;
    }

    private bool HasMyShip(int row, int col)
    {
        if (CurrentGame == null) return false;
        var coord = new Coordinate(row, col);
        var board = PlayerId == CurrentGame.Player1Id ? CurrentGame.Player1Board : CurrentGame.Player2Board;
        return board.Ships.Any(s => s.OccupiedCoordinates.Contains(coord));
    }

    private string GetCellClass(CellState state)
    {
        return state switch
        {
            CellState.Hit => "hit",
            CellState.Miss => "miss",
            CellState.Sunk => "sunk",
            _ => ""
        };
    }
}
